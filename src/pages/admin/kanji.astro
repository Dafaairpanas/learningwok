---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { Plus } from "lucide-react";
---

<AdminLayout title="Kelola Kanji">
  <div class="space-y-8">
    <!-- Header -->
    <div class="flex items-end justify-between border-b border-ink pb-6">
      <div>
        <h2 class="text-4xl font-black uppercase tracking-tighter text-ink">
          Daftar Kanji
        </h2>
        <p
          id="total-count"
          class="text-sm font-bold uppercase tracking-widest text-subtle mt-2"
        >
          Syncing Database...
        </p>
      </div>
      <button
        id="add-btn"
        class="inline-flex items-center gap-2 border-2 border-ink bg-brand-neon px-6 py-3 text-sm font-bold uppercase tracking-widest text-ink hover:bg-brand-orange hover:translate-x-1 hover:-translate-y-1 transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-none"
      >
        <Plus className="h-4 w-4" />
        Tambah Kanji
      </button>
    </div>

    <!-- Swiss Table -->
    <div class="border border-border-line bg-canvas">
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse" id="kanji-table">
          <thead>
            <tr class="border-b border-border-line bg-surface">
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink border-r border-border-line w-24"
                >Karakter</th
              >
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink border-r border-border-line"
                >Arti</th
              >
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink border-r border-border-line"
                >Onyomi</th
              >
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink border-r border-border-line"
                >Kunyomi</th
              >
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink border-r border-border-line w-24 text-center"
                >Level</th
              >
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink text-right w-32"
                >Aksi</th
              >
            </tr>
          </thead>
          <tbody id="table-body" class="divide-y divide-border-line">
            <tr>
              <td
                colspan="6"
                class="p-8 text-center text-subtle font-medium animate-pulse"
              >
                INITIALIZING DATA STREAM...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal (Swiss Style) -->
  <div
    id="kanji-modal"
    class="fixed inset-0 z-50 hidden"
    aria-labelledby="modal-title"
    role="dialog"
    aria-modal="true"
  >
    <!-- Backdrop -->
    <div
      id="modal-backdrop"
      class="fixed inset-0 bg-ink/80 backdrop-blur-sm transition-opacity"
    >
    </div>

    <!-- Modal Panel -->
    <div class="fixed inset-0 z-10 overflow-y-auto">
      <div
        class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0"
      >
        <div
          class="relative transform overflow-hidden bg-canvas text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border-2 border-ink"
        >
          <div class="bg-brand-neon p-4 border-b-2 border-ink">
            <h3
              class="text-xl font-black uppercase tracking-tighter text-ink"
              id="modal-title"
            >
              TAMBAH KANJI
            </h3>
          </div>

          <div class="p-6">
            <form id="kanji-form" class="space-y-6">
              <input type="hidden" id="kanji-id" name="id" />

              <div class="grid grid-cols-2 gap-6">
                <div>
                  <label
                    for="character"
                    class="block text-xs font-bold uppercase tracking-widest text-ink mb-2"
                  >
                    Karakter
                  </label>
                  <input
                    type="text"
                    id="character"
                    required
                    class="block w-full border-2 border-border-line bg-surface p-3 font-jp text-lg font-bold focus:border-ink focus:outline-none focus:ring-0 transition-colors"
                    placeholder="Ex: 日"
                  />
                </div>
                <div>
                  <label
                    for="jlpt_level"
                    class="block text-xs font-bold uppercase tracking-widest text-ink mb-2"
                  >
                    Level
                  </label>
                  <select
                    id="jlpt_level"
                    class="block w-full border-2 border-border-line bg-surface p-3 font-bold focus:border-ink focus:outline-none focus:ring-0 transition-colors"
                  >
                    <option value="N5">N5</option>
                    <option value="N4">N4</option>
                    <option value="N3">N3</option>
                  </select>
                </div>
              </div>

              <div>
                <label
                  for="meaning"
                  class="block text-xs font-bold uppercase tracking-widest text-ink mb-2"
                >
                  Arti
                </label>
                <input
                  type="text"
                  id="meaning"
                  required
                  class="block w-full border-2 border-border-line bg-canvas p-3 font-medium focus:border-ink focus:outline-none focus:ring-0 transition-colors"
                  placeholder="Ex: Matahari, Hari"
                />
              </div>

              <div class="grid grid-cols-2 gap-6">
                <div>
                  <label
                    for="onyomi"
                    class="block text-xs font-bold uppercase tracking-widest text-ink mb-2"
                    >Onyomi</label
                  >
                  <input
                    type="text"
                    id="onyomi"
                    class="block w-full border-2 border-border-line bg-canvas p-3 font-jp focus:border-ink focus:outline-none focus:ring-0"
                    placeholder="Ex: ニチ"
                  />
                </div>
                <div>
                  <label
                    for="kunyomi"
                    class="block text-xs font-bold uppercase tracking-widest text-ink mb-2"
                    >Kunyomi</label
                  >
                  <input
                    type="text"
                    id="kunyomi"
                    class="block w-full border-2 border-border-line bg-canvas p-3 font-jp focus:border-ink focus:outline-none focus:ring-0"
                    placeholder="Ex: ひ"
                  />
                </div>
              </div>

              <div>
                <label
                  for="stroke_count"
                  class="block text-xs font-bold uppercase tracking-widest text-ink mb-2"
                >
                  Jumlah Coretan
                </label>
                <input
                  type="number"
                  id="stroke_count"
                  class="block w-full border-2 border-border-line bg-canvas p-3 focus:border-ink focus:outline-none focus:ring-0"
                  placeholder="Ex: 4"
                />
              </div>

              <div class="pt-4 flex gap-4">
                <button
                  type="button"
                  id="cancel-btn"
                  class="flex-1 border-2 border-border-line bg-canvas py-3 text-sm font-bold uppercase tracking-widest hover:bg-surface hover:text-ink transition-colors"
                >
                  Batal
                </button>
                <button
                  type="submit"
                  class="flex-1 border-2 border-ink bg-ink text-canvas py-3 text-sm font-bold uppercase tracking-widest hover:bg-brand-orange hover:text-ink hover:border-ink transition-colors"
                >
                  Simpan Data
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  import { materiService } from "../../services/materi";
  import { adminService } from "../../services/admin";
  import type { KanjiInsert } from "../../services/admin";
  import type { KanjiWithLevel } from "../../services/materi";

  let kanjiList: KanjiWithLevel[] = [];

  // DOM Elements
  const tableBody = document.getElementById("table-body");
  const modal = document.getElementById("kanji-modal");
  const modalTitle = document.getElementById("modal-title");
  const form = document.getElementById("kanji-form") as HTMLFormElement;
  const addBtn = document.getElementById("add-btn");
  const cancelBtn = document.getElementById("cancel-btn");
  const backdrop = document.getElementById("modal-backdrop");
  const totalCountEl = document.getElementById("total-count");

  // Inputs
  const idInput = document.getElementById("kanji-id") as HTMLInputElement;
  const characterInput = document.getElementById(
    "character",
  ) as HTMLInputElement;
  const meaningInput = document.getElementById("meaning") as HTMLInputElement;
  const onyomiInput = document.getElementById("onyomi") as HTMLInputElement;
  const kunyomiInput = document.getElementById("kunyomi") as HTMLInputElement;
  const levelInput = document.getElementById("jlpt_level") as HTMLSelectElement;
  const strokeInput = document.getElementById(
    "stroke_count",
  ) as HTMLInputElement;

  // Render Table
  function renderTable(data: KanjiWithLevel[]) {
    if (!tableBody) return;

    if (data.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-subtle font-bold uppercase tracking-widest">No Data Found</td></tr>`;
      return;
    }

    tableBody.innerHTML = data
      .map(
        (item) => `
      <tr class="group hover:bg-surface transition-colors">
        <td class="p-4 border-r border-border-line">
          <span class="font-jp text-3xl font-bold text-ink">${item.character}</span>
        </td>
        <td class="p-4 border-r border-border-line font-medium text-ink">${item.meaning}</td>
        <td class="p-4 border-r border-border-line font-jp text-subtle">${item.onyomi || "-"}</td>
        <td class="p-4 border-r border-border-line font-jp text-subtle">${item.kunyomi || "-"}</td>
        <td class="p-4 border-r border-border-line text-center">
            <span class="inline-block border border-ink bg-canvas px-2 py-1 text-xs font-bold uppercase tracking-widest ${
              item.jlpt_level === "N5"
                ? "text-brand-green"
                : item.jlpt_level === "N4"
                  ? "text-brand-blue"
                  : "text-brand-purple"
            }">${item.jlpt_level || "?"}</span>
        </td>
        <td class="p-4 text-right">
          <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
            <button class="edit-btn p-2 border border-transparent hover:border-ink hover:bg-canvas text-subtle hover:text-ink transition-all" data-id="${item.id}" title="Edit">
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            </button>
            <button class="delete-btn p-2 border border-transparent hover:border-red-600 hover:bg-red-50 text-subtle hover:text-red-600 transition-all" data-id="${item.id}" title="Delete">
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
          </div>
        </td>
      </tr>
    `,
      )
      .join("");

    // Attach Event Listeners
    document.querySelectorAll(".edit-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const id = (e.currentTarget as HTMLElement).dataset.id;
        const item = kanjiList.find((k) => k.id === id);
        if (item) openModal(item);
      });
    });

    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const id = (e.currentTarget as HTMLElement).dataset.id;
        if (id) handleDelete(id);
      });
    });

    if (totalCountEl)
      totalCountEl.textContent = `${data.length} KANJI CONNECTED`;
  }

  // Initial Load
  async function loadData() {
    try {
      kanjiList = await materiService.getKanji(10000);
      renderTable(kanjiList);
    } catch (err) {
      console.error(err);
      if (tableBody)
        tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-red-600 font-bold uppercase tracking-widest">Connection Failed</td></tr>`;
    }
  }

  loadData();

  // Modal Actions
  function openModal(item: KanjiWithLevel | null = null) {
    if (!modal) return;
    modal.classList.remove("hidden");
    if (item) {
      if (modalTitle) modalTitle.textContent = "EDIT KANJI";
      idInput.value = item.id;
      characterInput.value = item.character;
      meaningInput.value = item.meaning;
      onyomiInput.value = item.onyomi || "";
      kunyomiInput.value = item.kunyomi || "";
      levelInput.value = item.jlpt_level || "N5";
      strokeInput.value = item.stroke_count?.toString() || "";
    } else {
      if (modalTitle) modalTitle.textContent = "TAMBAH KANJI";
      form.reset();
      idInput.value = "";
      levelInput.value = "N5";
    }
  }

  function closeModal() {
    if (modal) modal.classList.add("hidden");
  }

  addBtn?.addEventListener("click", () => openModal());
  cancelBtn?.addEventListener("click", closeModal);
  backdrop?.addEventListener("click", closeModal);

  // Form Submit
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const id = idInput.value;
    const payload: KanjiInsert = {
      character: characterInput.value,
      meaning: meaningInput.value,
      onyomi: onyomiInput.value || null,
      kunyomi: kunyomiInput.value || null,
      jlpt_level: levelInput.value,
      stroke_count: strokeInput.value ? parseInt(strokeInput.value) : null,
    };

    try {
      if (id) {
        await adminService.updateKanji(id, payload);
      } else {
        await adminService.createKanji(payload);
      }
      closeModal();
      loadData(); // Reload table
    } catch (err) {
      alert("Error: " + (err as Error).message);
    }
  });

  async function handleDelete(id: string) {
    if (!confirm("Are you sure you want to delete this Kanji record?")) return;
    try {
      await adminService.deleteKanji(id);
      loadData();
    } catch (err) {
      alert("Failed to delete: " + (err as Error).message);
    }
  }
</script>

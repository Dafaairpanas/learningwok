---
import AdminLayout from "../../layouts/AdminLayout.astro";
import { Plus, Map, Calendar } from "lucide-react";
---

<AdminLayout title="Kelola Roadmap">
  <div class="space-y-8">
    <div class="flex items-end justify-between border-b border-ink pb-6">
      <div>
        <h2 class="text-4xl font-black uppercase tracking-tighter text-ink">
          Learning Roadmap
        </h2>
        <p
          id="total-count"
          class="text-sm font-bold uppercase tracking-widest text-subtle mt-2"
        >
          Syncing Database...
        </p>
      </div>
      <button
        id="add-btn"
        class="inline-flex items-center gap-2 border-2 border-ink bg-brand-neon px-6 py-3 text-sm font-bold uppercase tracking-widest text-ink hover:bg-brand-orange hover:translate-x-1 hover:-translate-y-1 transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-none"
      >
        <Plus className="h-4 w-4" />
        Tambah Day
      </button>
    </div>

    <!-- Filter Toolbar -->
    <div
      class="flex flex-col md:flex-row gap-4 bg-surface border border-ink p-4 mb-0 border-b-0"
    >
      <div class="flex-1">
        <input
          type="text"
          id="search-input"
          class="w-full border-2 border-border-line bg-canvas p-2 text-sm font-bold focus:border-ink focus:outline-none transition-colors"
          placeholder="Cari Judul Day..."
        />
      </div>
      <div>
        <select
          id="filter-level"
          class="w-full md:w-48 border-2 border-border-line bg-canvas p-2 text-sm font-bold focus:border-ink focus:outline-none transition-colors"
        >
          <option value="">SEMUA LEVEL</option>
          <option value="N5">N5</option>
          <option value="N4">N4</option>
          <option value="N3">N3</option>
          <option value="N2">N2</option>
          <option value="N1">N1</option>
        </select>
      </div>
    </div>

    <!-- Table -->
    <div class="border border-border-line bg-canvas">
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="border-b border-border-line bg-surface">
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink border-r border-border-line w-24 text-center"
                >Level</th
              >
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink border-r border-border-line w-20 text-center"
                >Day</th
              >
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink border-r border-border-line"
                >Judul</th
              >
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink border-r border-border-line w-32 text-center"
                >Topics</th
              >
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink border-r border-border-line w-28 text-center"
                >Menit</th
              >
              <th
                class="p-4 text-xs font-black uppercase tracking-widest text-ink text-right w-28"
                >Aksi</th
              >
            </tr>
          </thead>
          <tbody id="table-body" class="divide-y divide-border-line">
            <tr>
              <td
                colspan="6"
                class="p-8 text-center text-subtle font-medium animate-pulse"
              >
                INITIALIZING DATA STREAM...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Add/Edit Day -->
  <div
    id="day-modal"
    class="fixed inset-0 z-50 hidden"
    aria-labelledby="modal-title"
    role="dialog"
    aria-modal="true"
  >
    <div
      id="modal-backdrop"
      class="fixed inset-0 bg-ink/80 backdrop-blur-sm transition-opacity"
    >
    </div>

    <div
      class="flex min-h-screen items-center justify-center px-4 pt-4 pb-20 text-center sm:p-0"
    >
      <div
        class="relative inline-block transform overflow-hidden bg-canvas text-left align-bottom shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border-2 border-ink sm:align-middle"
      >
        <div class="bg-brand-neon p-4 border-b-2 border-ink">
          <h3
            class="text-xl font-black uppercase tracking-tighter text-ink"
            id="modal-title"
          >
            TAMBAH LEARNING DAY
          </h3>
        </div>

        <div class="p-6">
          <form id="day-form" class="space-y-6">
            <input type="hidden" id="day-id" name="id" />

            <div class="grid grid-cols-2 gap-6">
              <div>
                <label
                  for="jlpt_level"
                  class="block text-xs font-bold uppercase tracking-widest text-ink mb-2"
                  >Level JLPT</label
                >
                <select
                  id="jlpt_level"
                  required
                  class="block w-full border-2 border-border-line bg-surface p-3 font-bold focus:border-ink focus:outline-none focus:ring-0 transition-colors"
                >
                  <option value="N5">N5</option>
                  <option value="N4">N4</option>
                  <option value="N3">N3</option>
                </select>
              </div>
              <div>
                <label
                  for="day_number"
                  class="block text-xs font-bold uppercase tracking-widest text-ink mb-2"
                  >Day Number</label
                >
                <input
                  type="number"
                  id="day_number"
                  required
                  min="1"
                  class="block w-full border-2 border-border-line bg-surface p-3 font-bold focus:border-ink focus:outline-none focus:ring-0 transition-colors"
                  placeholder="1"
                />
              </div>
            </div>

            <div>
              <label
                for="title"
                class="block text-xs font-bold uppercase tracking-widest text-ink mb-2"
                >Judul</label
              >
              <input
                type="text"
                id="title"
                required
                class="block w-full border-2 border-border-line bg-surface p-3 font-bold focus:border-ink focus:outline-none focus:ring-0 transition-colors"
                placeholder="Huruf & Sapaan Dasar"
              />
            </div>

            <div>
              <label
                for="description"
                class="block text-xs font-bold uppercase tracking-widest text-ink mb-2"
                >Deskripsi</label
              >
              <textarea
                id="description"
                rows="2"
                class="block w-full border-2 border-border-line bg-canvas p-3 text-sm focus:border-ink focus:outline-none focus:ring-0 transition-colors"
                placeholder="Deskripsi singkat untuk day ini..."></textarea>
            </div>

            <div class="grid grid-cols-2 gap-6">
              <div>
                <label
                  for="estimated_minutes"
                  class="block text-xs font-bold uppercase tracking-widest text-ink mb-2"
                  >Estimasi (menit)</label
                >
                <input
                  type="number"
                  id="estimated_minutes"
                  min="5"
                  class="block w-full border-2 border-border-line bg-surface p-3 font-bold focus:border-ink focus:outline-none focus:ring-0 transition-colors"
                  placeholder="30"
                />
              </div>
              <div class="flex items-end">
                <label class="flex items-center gap-3 cursor-pointer p-3">
                  <input type="checkbox" id="is_review_day" class="w-5 h-5" />
                  <span class="text-sm font-bold uppercase">Review Day?</span>
                </label>
              </div>
            </div>

            <div class="pt-4 flex gap-4">
              <button
                type="button"
                id="cancel-btn"
                class="flex-1 border-2 border-border-line bg-canvas py-3 text-sm font-bold uppercase tracking-widest hover:bg-surface hover:text-ink transition-colors"
              >
                Batal
              </button>
              <button
                type="submit"
                class="flex-1 border-2 border-ink bg-ink text-canvas py-3 text-sm font-bold uppercase tracking-widest hover:bg-brand-orange hover:text-ink hover:border-ink transition-colors"
              >
                Simpan
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  import { adminService } from "../../services/admin";

  interface LearningDayWithTopics {
    id: string;
    jlpt_level: string;
    day_number: number;
    title: string;
    description: string | null;
    estimated_minutes: number;
    is_review_day: boolean;
    topics: { count: number }[];
  }

  let daysList: LearningDayWithTopics[] = [];

  // DOM Elements
  const tableBody = document.getElementById("table-body");
  const modal = document.getElementById("day-modal");
  const modalTitle = document.getElementById("modal-title");
  const form = document.getElementById("day-form") as HTMLFormElement;
  const addBtn = document.getElementById("add-btn");
  const cancelBtn = document.getElementById("cancel-btn");
  const backdrop = document.getElementById("modal-backdrop");
  const totalCountEl = document.getElementById("total-count");

  // Filter Elements
  const searchInput = document.getElementById(
    "search-input",
  ) as HTMLInputElement;
  const filterLevel = document.getElementById(
    "filter-level",
  ) as HTMLSelectElement;

  // Form Inputs
  const idInput = document.getElementById("day-id") as HTMLInputElement;
  const levelInput = document.getElementById("jlpt_level") as HTMLSelectElement;
  const dayNumberInput = document.getElementById(
    "day_number",
  ) as HTMLInputElement;
  const titleInput = document.getElementById("title") as HTMLInputElement;
  const descriptionInput = document.getElementById(
    "description",
  ) as HTMLTextAreaElement;
  const minutesInput = document.getElementById(
    "estimated_minutes",
  ) as HTMLInputElement;
  const reviewDayInput = document.getElementById(
    "is_review_day",
  ) as HTMLInputElement;

  // Filter Logic
  function applyFilters() {
    const term = searchInput?.value.toLowerCase() || "";
    const level = filterLevel?.value || "";

    const filtered = daysList.filter((item) => {
      const matchText = item.title.toLowerCase().includes(term);
      const matchLevel = level ? item.jlpt_level === level : true;
      return matchText && matchLevel;
    });

    renderTable(filtered);
  }

  searchInput?.addEventListener("input", applyFilters);
  filterLevel?.addEventListener("change", applyFilters);

  function renderTable(data: LearningDayWithTopics[]) {
    if (!tableBody) return;
    if (data.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-subtle font-bold uppercase tracking-widest">No Data Found</td></tr>`;
      return;
    }

    if (totalCountEl) totalCountEl.textContent = `${data.length} LEARNING DAYS`;

    tableBody.innerHTML = data
      .map(
        (item) => `
        <tr class="group hover:bg-surface transition-colors">
            <td class="p-4 border-r border-border-line text-center">
                <span class="inline-block border border-ink bg-canvas px-2 py-1 text-xs font-bold uppercase tracking-widest ${
                  item.jlpt_level === "N5"
                    ? "text-brand-green"
                    : item.jlpt_level === "N4"
                      ? "text-brand-blue"
                      : "text-brand-purple"
                }">${item.jlpt_level}</span>
            </td>
            <td class="p-4 border-r border-border-line text-center font-black text-2xl text-ink">${item.day_number}</td>
            <td class="p-4 border-r border-border-line">
                <div class="font-bold text-ink">${item.title}</div>
                ${item.description ? `<div class="text-xs text-subtle mt-1 truncate max-w-xs">${item.description}</div>` : ""}
                ${item.is_review_day ? '<span class="inline-block mt-1 px-2 py-0.5 bg-brand-orange text-ink text-xs font-bold uppercase">Review</span>' : ""}
            </td>
            <td class="p-4 border-r border-border-line text-center font-bold text-ink">${item.topics?.[0]?.count || 0}</td>
            <td class="p-4 border-r border-border-line text-center font-medium text-ink">${item.estimated_minutes} min</td>
            <td class="p-4 text-right">
                <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <a href="/admin/roadmap-day?id=${item.id}" class="p-2 border border-transparent hover:border-ink hover:bg-canvas text-subtle hover:text-ink transition-all" title="Edit Topics">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                  </a>
                  <button class="edit-btn p-2 border border-transparent hover:border-ink hover:bg-canvas text-subtle hover:text-ink transition-all" data-id="${item.id}" title="Edit Day">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                  </button>
                  <button class="delete-btn p-2 border border-transparent hover:border-red-600 hover:bg-red-50 text-subtle hover:text-red-600 transition-all" data-id="${item.id}" title="Delete">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                  </button>
                </div>
            </td>
        </tr>
      `,
      )
      .join("");

    // Attach Listeners
    document.querySelectorAll(".edit-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const id = (e.currentTarget as HTMLElement).dataset.id;
        const item = daysList.find((d) => d.id === id);
        if (item) openModal(item);
      });
    });

    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const id = (e.currentTarget as HTMLElement).dataset.id;
        if (id) handleDelete(id);
      });
    });
  }

  async function loadData() {
    try {
      const data = await adminService.getLearningDays();
      daysList = data as LearningDayWithTopics[];
      renderTable(daysList);
    } catch (err) {
      console.error(err);
      if (tableBody)
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-red-600 font-bold uppercase tracking-widest py-8">Connection Failed</td></tr>`;
    }
  }

  function openModal(item: LearningDayWithTopics | null = null) {
    if (modal) modal.classList.remove("hidden");
    if (modalTitle)
      modalTitle.textContent = item
        ? "EDIT LEARNING DAY"
        : "TAMBAH LEARNING DAY";

    if (item) {
      idInput.value = item.id;
      levelInput.value = item.jlpt_level;
      dayNumberInput.value = String(item.day_number);
      titleInput.value = item.title;
      descriptionInput.value = item.description || "";
      minutesInput.value = String(item.estimated_minutes);
      reviewDayInput.checked = item.is_review_day;
    } else {
      form.reset();
      idInput.value = "";
      levelInput.value = "N5";
      minutesInput.value = "30";
    }
  }

  function closeModal() {
    if (modal) modal.classList.add("hidden");
  }

  addBtn?.addEventListener("click", () => openModal(null));
  cancelBtn?.addEventListener("click", closeModal);
  backdrop?.addEventListener("click", closeModal);

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const id = idInput.value;
    const payload = {
      jlpt_level: levelInput.value,
      day_number: parseInt(dayNumberInput.value),
      title: titleInput.value,
      description: descriptionInput.value || null,
      estimated_minutes: parseInt(minutesInput.value) || 30,
      is_review_day: reviewDayInput.checked,
    };

    try {
      if (id) {
        await adminService.updateLearningDay(id, payload);
      } else {
        await adminService.createLearningDay(payload);
      }
      closeModal();
      loadData();
    } catch (err) {
      alert("Error: " + (err as Error).message);
    }
  });

  async function handleDelete(id: string) {
    if (
      !confirm(
        "Hapus Learning Day ini? Semua topics dan items juga akan terhapus!",
      )
    )
      return;
    try {
      await adminService.deleteLearningDay(id);
      loadData();
    } catch (err) {
      alert("Delete failed: " + (err as Error).message);
    }
  }

  // Init
  loadData();
</script>
